% r_NL_VDV.m% 22 July 2011%  2 March 2018 -- revised for nonlinear process% van de vuuse reactor model% first, setpoint change only  ysp = [0];      % setpoint change (from 0 vector); dimension ny  timesp = 1;   % time of setpoint change  dist = [0.01];   % magnitude of input disturbance; dimension nd  timedis = 6;  % time of input disturbance  delt = 0.1;              % sample time  tfinal = 6;% model parameters (continuous time, state space Van de Vusse)   am = [-2.4048 0;0.8333 -2.2381];  bm = [7 7; -1.117 -1.117]; % 1 manip input, 1 dist  cm = [0 1];  dm = [0 0];  ninputs = size(bm,2);     % includes disturbance input  noutputs = size(cm,1);  nstates = size(am,1);     % number of model states  sysc_mod = ss(am,bm,cm,dm);%% discretize the model  sysd_mod = c2d(sysc_mod,delt);  [phi_mod,gamma_stuff,cd_mod,dd_stuff] = ssdata(sysd_mod)%  gamma_mod  = gamma_stuff(:,1);   % first input is manipulated  gammad_mod = gamma_stuff(:,2);   % second disturbances% ------------ plant parameters -------------------------------  planteqns = 'NL_VDVode'  cplant = [0 1];   % state 2 is the output  nstates_p = 2;      % two plant states   parvec(1) = 0.5714 ; % dilution rate, 0.5714 min^-1   parvec(2) = 10; % feed concentration of A, 10 gmol/liter   parvec(3) = 3; % conc A, 3gmol/liter   parvec(4) = 1.117; % conc B, 1.117 gmol/liter   parvec(5) = 5/6; % 5/6 min^-1   parvec(6) = 5/3; % 5/3   parvec(7) = 1/6; % 1/6% controller parameters  p = 10;       % prediction horizon  m = 1;        % control horizon  ny = 1;       % number of measured outputs  nu = 1;       % number of manipulated inputs  nd = 1;       % number of actual disturbances  nd_est = 1;   % number of estimated disturbances  weightu = [0]; % weighting matrix for control action  weighty = [1];      % weighting matrix for outputs% constraints  umin = [-1000];  umax = [1000];  dumin = [-1000];  dumax = [1000];% Kalman Filter matrices  Q  = eye(nd_est,nd_est);       % state covariance - need to generalize!  R  = eye(ny);%    isim = 2; % additive output disturbance  iqp = 1;  % unconstrained solution  noisemag = zeros(ny,1); % no noise% run simulation  QSSmpcNLPlant% zero-order hold on input and setpoint  [tt,uu] = stairs(t,u');  [ttr,rr] = stairs(t,r');%%  plot the actual plant output without measurement noise  figure(111)  subplot(2,1,1)  plot(ttr,rr+1.117,':',t,y+1.117)  ylabel('y')  xlabel('time')  title('NL VDV. DMC: P = 10, M = 3')  subplot(2,1,2)  plot(tt,uu+0.5714)  ylabel('u')  xlabel('time')  t1 = t; y1 = y+1.117; tt1 = tt; uu1 = uu+0.5714; ttr1 = ttr; rr1 = rr+1.117;% ---------------- unconstrained simulations ------------  isim = 1; % DMC  iqp  = 1 % unconstrained  p = 25;  m = 1;  % run simulation  QSSmpcNLPlant% zero-order hold on input and setpoint  [tt,uu] = stairs(t,u');  [ttr,rr] = stairs(t,r');  figure(112)  subplot(2,1,1)  plot(t,y+1.117,ttr,rr+1.117,':')  ylabel('y')  xlabel('time')  title('NL VDV. DMC: P = 25, M = 1')  subplot(2,1,2)  plot(tt,uu+0.5714)  ylabel('u')  xlabel('time')  t2 = t; y2 = y+1.117; tt2 = tt; uu2 = uu+0.5714; ttr2 = ttr; rr2 = rr+1.117;% --------------- compare  figure(113)  subplot(2,1,1)  plot(t1,y1,t2,y2,ttr2,rr2,':')  legend('P = 10, M = 3','P = 25, M = 1')  ylabel('y')  xlabel('time')  title('NL VDV. DMC: P = 25, M = 1 and P = 10, M = 3')  subplot(2,1,2)  plot(tt1,uu1,tt2,uu2)  legend('P = 10, M = 3','P = 25, M = 1')  ylabel('u')  xlabel('time')%------------------------------------------------% show stability limit  isim = 1; % DMC  iqp  = 1 % unconstrained  p = 8;  m = 1;  % run simulation  QSSmpcNLPlant% zero-order hold on input and setpoint  [tt,uu] = stairs(t,u');  [ttr,rr] = stairs(t,r');  t3 = t; y3 = y+1.117; tt3 = tt; uu3 = uu+0.5714; ttr3 = ttr; rr3 = rr+1.117;%  p = 7;    % unstable prediction horizon  m = 1;  % run simulation  QSSmpcNLPlant% zero-order hold on input and setpoint  [tt,uu] = stairs(t,u');  [ttr,rr] = stairs(t,r');  t4 = t; y4 = y+1.117; tt4 = tt; uu4 = uu+0.5714; ttr4 = ttr; rr4 = rr+1.117;  figure(115)  subplot(2,1,1)  plot(t3,y3,t4,y4,ttr4,rr4,':')%  axis([0 6 -1.5 1.5])  legend('P = 8, M = 1','P = 7, M = 1')  ylabel('y')  xlabel('time')  title('NL VDV. DMC: P = 8, M = 1 and P = 7, M = 1')  subplot(2,1,2)  plot(tt3,uu3,tt4,uu4)%  axis([0 6 -7 3])  ylabel('u')  xlabel('time')% -------% constrained  umin = [-0.5714];  umax = [5];  dumin = [-1000];  dumax = [1000];  iqp  = 2 % constrained   QSSmpcNLPlant% zero-order hold on input and setpoint  [tt,uu] = stairs(t,u');  [ttr,rr] = stairs(t,r');  t5 = t; y5 = y+1.117; tt5 = tt; uu5 = uu+0.5714; ttr5 = ttr; rr5 = rr+1.117;  figure(116)  subplot(2,1,1)  plot(t4,y4,t5,y5,ttr5,rr5,':')%  axis([0 6 -1.5 1.5])  legend('Unconstrained','QP')  ylabel('y')  xlabel('time')  title('NL VDV. DMC: P = , M = 1; unconstrained and QP')  subplot(2,1,2)  plot(tt4,uu4,tt5,uu5)%  axis([0 6 -7 3])  ylabel('u')  xlabel('time')